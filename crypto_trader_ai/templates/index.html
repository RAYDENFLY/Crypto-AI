<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CryptoTrader AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Inter', sans-serif; }
    #image-upload {
    display: none !important;
}
  </style>
</head>
<body class="bg-[#12182b] text-[#cbd5e1] min-h-screen flex justify-center p-4">
  <div id="spinner" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="w-8 h-8 border-4 border-t-transparent border-[#6c63ff] rounded-full animate-spin"></div>
  </div>

  <div class="max-w-5xl w-full space-y-6">
    <!-- Header -->
    <header class="flex items-center space-x-3 bg-[#1a203e] rounded-t-md px-4 py-2 relative">
      <div class="w-7 h-7 rounded-full bg-[#6c63ff] flex items-center justify-center">
        <i class="fas fa-chart-bar text-white text-sm"></i>
      </div>
      <div>
        <h1 class="text-white font-semibold text-sm leading-5">CryptoTrader AI</h1>
        <p class="text-[#94a3b8] text-xs leading-4">By PT Authentic Media Services</p>
      </div>
      <div class="absolute right-4 top-2 flex items-center space-x-3 text-xs font-semibold">
        <div class="flex items-center space-x-1 text-[#22c55e]">
          <span class="w-2 h-2 rounded-full bg-[#22c55e] block"></span>
          <span>Market Open</span>
        </div>
        <div class="flex items-center space-x-1 text-[#60a5fa]">
          <i class="fas fa-sync-alt"></i>
          <span>Real-time Data</span>
        </div>
        <div class="flex items-center space-x-1 text-[#a78bfa]">
          <i class="fas fa-robot"></i>
          <span>AI Analysis</span>
        </div>
      </div>
    </header>

    <!-- Market Analysis -->
    <section class="space-y-2">
        <div class="mb-4">
    <div class="bg-[#fbbf24] text-[#78350f] px-4 py-2 rounded shadow text-xs flex items-center gap-2 justify-center">
      <i class="fas fa-exclamation-triangle"></i>
      Data, analisis, dan saran AI di aplikasi ini tidak sepenuhnya akurat dan bukan merupakan nasihat keuangan resmi.
    </div>
  </div>
      <h2 class="text-white font-semibold text-sm">Market Analysis</h2>
      <div class="bg-[#1a203e] rounded-md p-4 pb-[50px] space-y-4">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-3 sm:space-y-0">
          <div class="flex items-center space-x-4">
            <select id="coinSelect" onchange="loadChartData()" class="bg-[#2a3153] text-[#94a3b8] text-xs rounded-md px-3 py-1 focus:outline-none">
              <option value="bitcoin">Bitcoin (BTC)</option>
              <option value="ethereum">Ethereum (ETH)</option>
              <option value="solana">Solana (SOL)</option>
            </select>
            <div class="flex items-center space-x-2 text-white font-semibold text-lg">
              <span id="currentPrice">$0.00</span>
              <span id="priceChange" class="bg-[#22c55e] text-[10px] font-semibold rounded px-1.5 py-0.5 flex items-center gap-1">
                <i class="fas fa-arrow-up"></i> +0%
              </span>
            </div>
          </div>
          <div class="flex justify-end">
            <select id="chartType" onchange="loadChartData()" class="bg-[#2a3153] text-[#94a3b8] text-xs rounded-md px-2 py-1">
              <option value="line">coingecko</option>
              <option value="candlestick">TradingView</option>
              <option value="binance">Binance</option>
            </select>
          </div>

          <div class="flex space-x-2 text-[#94a3b8] text-xs font-semibold">
            <button class="px-2 py-1 rounded-md hover:bg-[#2a3153] timeframe-btn" data-days="0.0007">1m</button>
            <button class="px-2 py-1 rounded-md hover:bg-[#2a3153] timeframe-btn" data-days="0.04">1H</button>
            <button class="px-2 py-1 rounded-md hover:bg-[#2a3153] timeframe-btn" data-days="0.17">4H</button>
            <button class="px-2 py-1 rounded-md bg-[#2a3153] timeframe-btn" data-days="1">1D</button>
            <button class="px-2 py-1 rounded-md hover:bg-[#2a3153] timeframe-btn" data-days="7">1W</button>
            <button class="px-2 py-1 rounded-md hover:bg-[#2a3153] timeframe-btn" data-days="30">1M</button>
          </div>
        </div>

        <!-- Line Chart Canvas -->
        <div style="height: 500px;">
          <canvas id="btcChart"></canvas>
          <div id="ohlcInfo" class="mt-2 text-xs text-[#94a3b8] font-mono"></div>
        </div>

        <!-- TradingView Widget -->
       <div class="tradingview-widget-container hidden" style="height: 500px;">
       <div id="tradingview_btc" style="height: 100%; width: 100%;"></div>
          <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
          <script type="text/javascript">
          function loadChartData() {
            const selectedCoin = document.getElementById('coinSelect').value;
            let symbol;

            // Mapping value dari select ke simbol TradingView
            switch (selectedCoin) {
              case 'bitcoin':
                symbol = 'BINANCE:BTCUSDT';
                break;
              case 'ethereum':
                symbol = 'BINANCE:ETHUSDT';
                break;
              case 'solana':
                symbol = 'BINANCE:SOLUSDT';
                break;
              default:
                symbol = 'BINANCE:BTCUSDT';
            }

            // Hapus widget lama
            document.getElementById('tradingview_btc').innerHTML = '';

            // Buat widget baru
            new TradingView.widget({
              "container_id": "tradingview_btc",
              "symbol": symbol,
              "interval": "60",
              "timezone": "Etc/UTC",
              "theme": "dark",
              "style": "1",
              "locale": "en",
              "toolbar_bg": "#1a203e",
              "enable_publishing": false,
              "withdateranges": true,
              "hide_side_toolbar": false,
              "allow_symbol_change": true,
              "studies": [],
              "autosize": true
            });
          }

          // Inisialisasi chart saat halaman pertama kali dibuka
          window.onload = loadChartData;
        </script>
        
        </div>
      </div>
    </section>

    <!-- AI Chat Assistant -->
    <section class="space-y-2">
      <div class="flex justify-between items-center">
        <div>
          <h2 class="text-white font-semibold text-sm">AI Trading Assistant</h2>
          <p class="text-[#94a3b8] text-xs">Ask the assistant about market trends</p>
        </div>
        <div class="text-[#94a3b8] text-[10px] text-right">
          <span>Powered by</span><br>
          <span class="font-semibold text-white">OpenAI</span>
        </div>
      </div>
      <div class="bg-[#1a203e] rounded-md p-4">
        <div class="flex items-center mb-2 gap-2">
      <label for="chat-select" class="text-xs text-[#94a3b8]">Chat:</label>
      <select id="chat-select" class="bg-[#2a3153] text-[#94a3b8] text-xs rounded-md px-2 py-1"></select>
      <button id="new-chat-btn" class="bg-[#6c63ff] text-white text-xs rounded px-2 py-1 ml-2">New Chat</button>
      <label for="ai-model" class="text-xs text-[#94a3b8] ml-4">Model:</label>
      <select id="ai-model" class="bg-[#2a3153] text-[#94a3b8] text-xs rounded-md px-2 py-1">
        <option value="openai">OpenAI</option>
        <option value="mixtral">Mixtral-8x7b</option>
        <option value="groq">Groq Cloud (Llama-4 Scout 17B)</option>
        <option value="groq_vision">Groq Cloud (Llama-4 Vision 17B) - Gambar</option>
      </select>
    </div>
        <div id="chat-box" class="space-y-2 max-h-[900px] overflow-y-auto mb-2 text-base flex flex-col"></div>
        <form id="chat-form" class="flex items-center space-x-2">
          <input class="flex-grow bg-[#2a3153] rounded-md px-3 py-2 text-xs text-[#94a3b8]" placeholder="Ask about BTC trends..." type="text"/>
          <button type="submit" class="text-[#94a3b8] hover:text-white"><i class="fas fa-paper-plane"></i></button>
          <input id="image-upload" type="file" accept="image/*" class="hidden" />
          <label id="upload-label" for="image-upload" class="ml-2 cursor-pointer hidden text-[#94a3b8] hover:text-white" title="Upload gambar">
            <i class="fas fa-upload fa-lg"></i>
          </label>
        </form>
        <img id="image-preview" src="" alt="Preview" class="h-10 ml-2 rounded shadow hidden" />
      </div>
    </section>

      <!-- Footer Credit -->
  <footer class="w-full max-w-5xl mx-auto mt-8 text-center text-xs text-[#64748b] py-4">
    &copy; 2024 PT Authentic Media Services. All rights reserved.
  </footer>

  </div>
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <script>
    const ctx = document.getElementById("btcChart").getContext("2d");
    let chart;
    let currentDays = "1";
    let binanceIntervalId = null;

    function setActiveTimeframe(btn) {
      document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('bg-[#2a3153]'));
      btn.classList.add('bg-[#2a3153]');
    }

    function getBinanceInterval(days) {
      switch (days) {
        case "0.0007": return "1m"; // 1 menit
        case "0.04": return "1h"; // 1 jam
        case "0.17": return "4h"; // 4 jam
        case "1": return "1d";   // 1 hari
        case "7": return "1w";   // 1 minggu
        case "30": return "1M";  // 1 bulan
        default: return "1d";
      }
    }

    async function loadChartData() {
      const chartType = document.getElementById("chartType").value;
      const selectedCoin = document.getElementById("coinSelect").value;
      const canvas = document.getElementById("btcChart");
      const ohlcInfo = document.getElementById("ohlcInfo");
      const tradingView = document.querySelector(".tradingview-widget-container");
      const spinner = document.getElementById("spinner");
      const currentPriceEl = document.getElementById("currentPrice");
      const priceChangeEl = document.getElementById("priceChange");

      async function fetchFromBinance(coinSymbol, interval = '1h', limit = 100) {
      const symbol = coinSymbol.toUpperCase() + 'USDT';
      const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.map(d => ({
        time: d[0],
        open: parseFloat(d[1]),
        high: parseFloat(d[2]),
        low: parseFloat(d[3]),
        close: parseFloat(d[4])
      }));
    }

      if (chartType === "binance") {
        // Set polling interval to 5 seconds for Binance chart
        if (binanceIntervalId) clearInterval(binanceIntervalId);
        binanceIntervalId = setInterval(() => {
          if (document.getElementById("chartType").value === "binance") loadChartData();
        }, 5000);

        canvas.parentElement.style.display = "block";
        ohlcInfo.style.display = "block";
        tradingView.style.display = "none";

        // Hapus spinner biar chart dinamis tanpa loading
        spinner.classList.add("hidden");

        try {
          const coinSymbol = selectedCoin === "bitcoin" ? "BTC" :
                            selectedCoin === "ethereum" ? "ETH" :
                            selectedCoin === "solana" ? "SOL" : "BTC";

          const interval = getBinanceInterval(currentDays);
          const data = await fetchFromBinance(coinSymbol, interval);

          const prices = data.map(d => d.close);
          const times = data.map(d => new Date(d.time));

          currentPriceEl.textContent = `$${prices[prices.length - 1].toLocaleString()}`;

          const change = ((prices[prices.length - 1] - prices[0]) / prices[0]) * 100;
          const isPositive = change >= 0;
          priceChangeEl.className = `text-[10px] font-semibold rounded px-1.5 py-0.5 flex items-center gap-1 ${isPositive ? "bg-[#22c55e]" : "bg-[#ef4444]"}`;
          priceChangeEl.innerHTML = `<i class="fas ${isPositive ? "fa-arrow-up" : "fa-arrow-down"}"></i> ${isPositive ? "+" : ""}${change.toFixed(2)}%`;

          if (chart) chart.destroy();

          // Dynamic x-axis formatting
          let timeFormat = "";
          let xUnit = 'hour';
          let xStepSize = 1;
          switch (interval) {
          case "1m":
            timeFormat = "HH:mm";
            xUnit = 'minute';
            xStepSize = 1;
            break;
          case "1h":
            timeFormat = "HH:mm";
            xUnit = 'hour';
            xStepSize = 1;
            break;
          case "4h":
            timeFormat = "HH:mm";
            xUnit = 'hour';
            xStepSize = 4;
            break;
          case "1d":
            timeFormat = "dd MMM";
            xUnit = 'day';
            xStepSize = 1;
            break;
          case "1w":
            timeFormat = "MMM yyyy";
            xUnit = 'week';
            xStepSize = 1;
            break;
          case "1M":
            timeFormat = "yyyy";
            xUnit = 'month';
            xStepSize = 1;
            break;
        }


          chart = new Chart(ctx, {
            type: "line",
            data: {
              labels: times,
              datasets: [{
                label: `${coinSymbol} Price`,
                data: prices,
                borderColor: isPositive ? "#22c55e" : "#ef4444",
                backgroundColor: isPositive ? "rgba(34,197,94,0.1)" : "rgba(239,68,68,0.1)",
                tension: 0.3,
                fill: true,
                pointRadius: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: false,
              interaction: { mode: 'index', intersect: false },
              plugins: {
                legend: { display: false },
                tooltip: {
                  enabled: true,
                  callbacks: {
                    title: function(context) {
                      // Tampilkan tanggal dan waktu lengkap
                      const idx = context[0].dataIndex;
                      const date = times[idx];
                      return date.toLocaleString();
                    },
                    label: function(context) {
                      return `Harga: $${context.parsed.y.toLocaleString()}`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  unit: xUnit,
                  stepSize: xStepSize,
                  type: 'time',
                  time: {
                    tooltipFormat: 'yyyy-MM-dd HH:mm',
                    displayFormats: {
                      minute: timeFormat,
                      hour: timeFormat,
                      day: timeFormat,
                      week: timeFormat,
                      month: timeFormat,
                      year: timeFormat
                    },
                  },
                  ticks: {
                    color: "#94a3b8"
                  },
                  grid: { color: "#2a3153" }
                },
                y: {
                  title: {
                    display: true,
                    text: 'Price (USD)',
                    color: '#94a3b8',
                    font: { size: 12, weight: 'bold' }
                  },
                  ticks: { callback: val => "$" + val.toLocaleString(), color: "#94a3b8" },
                  grid: { color: "#2a3153" }
                }
              }
            },
            plugins: [{
              afterDraw: chart => {
                // Geser chart ke kanan saat data bertambah
                if (chart.data.labels.length > 0) {
                  chart.chartArea.left = 0;
                  chart.chartArea.right = chart.width;
                }
              }
            }]
          });

          const last = data[data.length - 1];
          ohlcInfo.innerHTML = `Price: $${last.close} | O: $${last.open} H: $${last.close} L: $${last.close} C: $${last.close}`;
        } catch (err) {
          console.error("Error loading Binance data:", err);
        } finally {
          spinner.classList.add("hidden");
        }
        return;
    }


      if (chartType === "line") {
        canvas.parentElement.style.display = "block";
        ohlcInfo.style.display = "block";
        tradingView.style.display = "none";
      } else {
        canvas.parentElement.style.display = "none";
        ohlcInfo.style.display = "none";
        tradingView.style.display = "block";
        return;
      }

      spinner.classList.remove("hidden");

      try {
        const res = await fetch(`/api/chart-data?coin=${selectedCoin}&days=${currentDays}`);
        const data = await res.json();

        currentPriceEl.textContent = `$${parseFloat(data.currentPrice).toLocaleString()}`;
        const change = parseFloat(data.changePercent).toFixed(2);
        const isPositive = change >= 0;
        priceChangeEl.className = `text-[10px] font-semibold rounded px-1.5 py-0.5 flex items-center gap-1 ${isPositive ? "bg-[#22c55e]" : "bg-[#ef4444]"}`;
        priceChangeEl.innerHTML = `<i class="fas ${isPositive ? "fa-arrow-up" : "fa-arrow-down"}"></i> ${isPositive ? "+" : ""}${change}%`;

        if (chart) chart.destroy();

        const chartData = {
          labels: data.times,
          datasets: [{
            label: `${selectedCoin.toUpperCase()} Price`,
            data: data.prices,
            borderColor: isPositive ? "#22c55e" : "#ef4444",
            backgroundColor: isPositive ? "rgba(34,197,94,0.1)" : "rgba(239,68,68,0.1)",
            tension: 0.3,
            fill: true,
          }]
        };

        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { display: false },
            y: {
              ticks: { callback: val => "$" + val.toLocaleString(), color: "#94a3b8" },
              grid: { color: "#2a3153" },
            }
          },
          plugins: { legend: { display: false } }
        };

        chart = new Chart(ctx, { type: "line", data: chartData, options: chartOptions });

        const last = data.ohlc[data.ohlc.length - 1];
         ohlcInfo.innerHTML = `Price: $${last.c} | O: $${last.o} H: $${last.h} L: $${last.l} C: $${last.c}`;
      } catch (err) {
        console.error("Error loading chart:", err);
      } finally {
        spinner.classList.add("hidden");
      }
    }

    document.querySelectorAll('.timeframe-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        currentDays = this.dataset.days;
        setActiveTimeframe(this);
        loadChartData();
      });
    });

    loadChartData();
    setInterval(loadChartData, 30000);
  </script>

  <script>
let currentChatId = null;

async function loadChats(selectedId = null) {
  const res = await fetch('/api/chats');
  const chats = await res.json();
  const chatSelect = document.getElementById('chat-select');
  chatSelect.innerHTML = '';
  chats.forEach(chat => {
    const opt = document.createElement('option');
    opt.value = chat.id;
    opt.textContent = chat.title + ' (' + new Date(chat.created_at).toLocaleString() + ')';
    chatSelect.appendChild(opt);
  });
  if (chats.length > 0) {
    if (selectedId && chats.some(c => c.id == selectedId)) {
      currentChatId = selectedId;
    } else if (currentChatId && chats.some(c => c.id == currentChatId)) {
      // keep currentChatId if still exists
    } else {
      currentChatId = chats[0].id;
    }
    chatSelect.value = currentChatId;
    loadChatMessages(currentChatId);
  } else {
    currentChatId = null;
    document.getElementById('chat-box').innerHTML = '';
  }
}

async function loadChatMessages(chatId) {
  const res = await fetch(`/api/chats/${chatId}/messages`);
  const messages = await res.json();
  const chatBox = document.getElementById('chat-box');
  chatBox.innerHTML = '';
  messages.forEach(msg => {
    appendMessage(msg.sender, msg.message);
  });
}

document.getElementById('chat-select').addEventListener('change', function() {
  currentChatId = this.value;
  loadChatMessages(currentChatId);
});

document.getElementById('new-chat-btn').addEventListener('click', async function() {
  const res = await fetch('/api/chats', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title: 'New Chat ' + new Date().toLocaleTimeString() })
  });
  const chat = await res.json();
  await loadChats(chat.id);
  document.getElementById('chat-select').value = chat.id;
  currentChatId = chat.id;
  document.getElementById('chat-box').innerHTML = '';
});

function appendMessage(sender, text) {
  const msg = document.createElement('div');
  msg.className = `flex items-start gap-2 p-2 rounded-md max-w-xl whitespace-pre-wrap ${sender === "user" ? "bg-[#334155] text-white self-end ml-auto flex-row-reverse" : "bg-[#2a3153] text-[#94a3b8] self-start"}`;
  // Profile image
  const img = document.createElement('img');
  img.className = "w-8 h-8 rounded-full object-cover shadow";
  if (sender === "user") {
    img.src = "/static/image/images.png";
    img.alt = "User";
  } else {
    // Get selected AI model name and image
    const aiModel = document.getElementById('ai-model').value;
    let aiName = "AI";
    let aiImg = "/static/image/images.png";
    if (aiModel === "openai") {
      aiName = "OpenAI";
      aiImg = "/static/image/images.png";
    } else if (aiModel === "mixtral") {
      aiName = "Mixtral-8x7b";
      aiImg = "/static/image/images.png";
    } else if (aiModel === "groq") {
      aiName = "Groq Cloud";
      aiImg = "/static/image/images.png";
    } else if (aiModel === "groq_vision") {
      aiName = "Groq Vision";
      aiImg = "/static/image/images.png";
    }
    img.src = aiImg;
    img.alt = aiName;
  }
  // Name label
  const nameDiv = document.createElement('div');
  nameDiv.className = "text-xs font-bold mb-1";
  nameDiv.textContent = sender === "user" ? "User" : (function(){
    const aiModel = document.getElementById('ai-model').value;
    if (aiModel === "openai") return "OpenAI";
    if (aiModel === "mixtral") return "Mixtral-8x7b";
    if (aiModel === "groq") return "Groq Cloud";
    if (aiModel === "groq_vision") return "Groq Vision";
    return "AI";
  })();
  // Message bubble
  const bubble = document.createElement('div');
  bubble.className = "flex flex-col";
  bubble.appendChild(nameDiv);
  const textDiv = document.createElement('div');
  // Render bold for **text**
  textDiv.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
  bubble.appendChild(textDiv);
  // Compose
  msg.appendChild(img);
  msg.appendChild(bubble);
  document.getElementById('chat-box').appendChild(msg);
  document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
}

const form = document.getElementById("chat-form");
const input = form.querySelector("input[type='text']");
const aiModelSelect = document.getElementById("ai-model");
const imageUpload = document.getElementById("image-upload");
const uploadLabel = document.getElementById("upload-label");
let imageBase64 = null;
let imagePreviewUrl = null;

aiModelSelect.addEventListener("change", function() {
  if (this.value === "groq_vision") {
    imageUpload.classList.remove("hidden");
    uploadLabel.classList.remove("hidden");
  } else {
    imageUpload.classList.add("hidden");
    uploadLabel.classList.add("hidden");
    imageBase64 = null;
    imagePreviewUrl = null;
    imageUpload.value = "";
  }
});

imageUpload.addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(evt) {
      imageBase64 = evt.target.result.split(",")[1];
      imagePreviewUrl = evt.target.result;
      // Show preview in chat as a bubble
      appendImageMessage("user", imagePreviewUrl);
    };
    reader.readAsDataURL(file);
  } else {
    imageBase64 = null;
    imagePreviewUrl = null;
  }
});

function appendImageMessage(sender, imgUrl) {
  const msg = document.createElement('div');
  msg.className = `flex items-start gap-2 p-2 rounded-md max-w-xl whitespace-pre-wrap ${sender === "user" ? "bg-[#334155] text-white self-end ml-auto flex-row-reverse" : "bg-[#2a3153] text-[#94a3b8] self-start"}`;
  // Profile image
  const imgProfile = document.createElement('img');
  imgProfile.className = "w-8 h-8 rounded-full object-cover shadow";
  if (sender === "user") {
    imgProfile.src = "/static/image/user.png";
    imgProfile.alt = "User";
  } else {
    const aiModel = document.getElementById('ai-model').value;
    let aiName = "AI";
    let aiImg = "/static/image/ai.png";
    if (aiModel === "openai") aiImg = "/static/image/openai.png";
    else if (aiModel === "mixtral") aiImg = "/static/image/mixtral.png";
    else if (aiModel === "groq") aiImg = "/static/image/groq.png";
    else if (aiModel === "groq_vision") aiImg = "/static/image/groq_vision.png";
    imgProfile.src = aiImg;
    imgProfile.alt = aiName;
  }
  // Name label
  const nameDiv = document.createElement('div');
  nameDiv.className = "text-xs font-bold mb-1";
  nameDiv.textContent = sender === "user" ? "User" : (function(){
    const aiModel = document.getElementById('ai-model').value;
    if (aiModel === "openai") return "OpenAI";
    if (aiModel === "mixtral") return "Mixtral-8x7b";
    if (aiModel === "groq") return "Groq Cloud";
    if (aiModel === "groq_vision") return "Groq Vision";
    return "AI";
  })();
  // Image bubble
  const bubble = document.createElement('div');
  bubble.className = "flex flex-col";
  bubble.appendChild(nameDiv);
  const img = document.createElement('img');
  img.src = imgUrl;
  img.alt = "Preview";
  img.className = "mt-2 rounded shadow max-w-xs";
  bubble.appendChild(img);
  msg.appendChild(imgProfile);
  msg.appendChild(bubble);
  document.getElementById('chat-box').appendChild(msg);
  document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const message = input.value.trim();
  if (!message) return;

  appendMessage("user", message);
  if (aiModelSelect.value === "groq_vision" && imagePreviewUrl) {
    appendImageMessage("user", imagePreviewUrl);
  }
  input.value = "";

  const loading = document.createElement("div");
  loading.className = "text-[#64748b] italic text-xs self-start";
  loading.textContent = "AI is typing...";
  document.getElementById('chat-box').appendChild(loading);

  try {
    const coin = document.getElementById("coinSelect").value;
    const timeframe = currentDays;
    const price = document.getElementById("currentPrice").textContent;
    const ohlc = document.getElementById("ohlcInfo").textContent;
    const model = aiModelSelect.value;
    let body = {
      message,
      model,
      chat_id: currentChatId,
      context: {
        coin,
        timeframe,
        price,
        ohlc
      }
    };
    if (model === "groq_vision" && imageBase64) {
      body.image = imageBase64;
    }
    const res = await fetch("/ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    loading.remove();
    appendMessage("ai", data.reply || "Sorry, no response.");
    if (data.image_url) {
      appendImageMessage("ai", data.image_url);
    }
    if (data.chat_id) {
      currentChatId = data.chat_id;
      await loadChats();
      document.getElementById('chat-select').value = currentChatId;
    }
    // Reset image after submit
    imageBase64 = null;
    imagePreviewUrl = null;
    imageUpload.value = "";
  } catch (err) {
    loading.remove();
    appendMessage("ai", "Error: " + err.message);
  }
});

// Initial load
loadChats();
  </script>
</body>
</html>
